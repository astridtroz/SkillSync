<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-3">
        <h3>Event Calendar</h3>
        <div id="calendar"></div>

        <!-- Add Event Modal -->
        <div id="eventModal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <form id="eventForm" class="modal-content">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Add Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="eventTitle" class="form-control mb-2" placeholder="Event Title" required>
                        <textarea id="eventDescription" class="form-control mb-2" placeholder="Description" required></textarea>
                        <input id="eventStart" type="date" class="form-control mb-2">
                        <input id="eventEnd" type="date" class="form-control">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary w-100">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Event Modal -->
        <div id="deleteEventModal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <p>Are you sure you want to delete this event?</p>
                        <button id="confirmDelete" class="btn btn-danger w-100 mb-2">Delete</button>
                        <button class="btn btn-secondary w-100" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nominate Members Modal -->
        <div id="nominateMemberModal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <form id="nominateForm" class="modal-content">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Nominate Members</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="membersContainer">
                            <!-- Checkboxes will be populated with JavaScript -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary w-100">Nominate</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var calendarEl = document.getElementById('calendar');
            var userId = '{{ request.user.id }}';
            var userRole = '{{ user_role }}';

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                dateClick: function(info) {
                    $('#eventStart').val(info.dateStr);
                    $('#eventEnd').val(info.dateStr);
                    $('#eventModal').modal('show');
                },
                events: '{% url "get_events" %}',
                eventClick: function(info) {
                    var eventId = info.event.id;
                    var eventOrganizerId = info.event.extendedProps.organizer_id;

                    if (eventOrganizerId == userId) {
                        // Show delete modal if the event is created by the logged-in user
                        $('#confirmDelete').data('event-id', eventId);
                        $('#deleteEventModal').modal('show');
                    } else if (userRole === 'leader') {
                        // Show nomination modal for leaders if the event is not created by them
                        $('#nominateMemberModal').modal('show');
                        $('#nominateForm').data('event-id', eventId);

                        // Load members associated with the project
                        $.get(
                            '{% url "get_members" %}',
                            function(members) {
                                var $membersContainer = $('#membersContainer');
                                $membersContainer.empty();
                                $.each(members, function(index, member) {
                                    $membersContainer.append(`
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="${member.id}" id="member${member.id}">
                                            <label class="form-check-label" for="member${member.id}">
                                                ${member.username}
                                            </label>
                                        </div>
                                    `);
                                });
                            },
                            'json'
                        ).fail(function() {
                            console.error('Failed to load members');
                        });
                    }
                },
                eventTimeFormat: { // Customizing the time format
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                },
                displayEventTime: false // Disable the display of time next to the event title
            });

            calendar.render();

            $('#eventForm').on('submit', function(e) {
                e.preventDefault();
                $.post(
                    '{% url "create_event" %}',
                    {
                        title: $('#eventTitle').val(),
                        description: $('#eventDescription').val(),
                        start: $('#eventStart').val(),
                        end: $('#eventEnd').val(),
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        allDay: true // Ensure events are marked as all-day
                    },
                    function(response) {
                        if (response.status === 'success') {
                            $('#eventModal').modal('hide');
                            calendar.addEvent(response.event);
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    'json'
                );
            });

            $('#confirmDelete').on('click', function() {
                $.post(
                    '{% url "delete_event" %}',
                    {
                        id: $(this).data('event-id'),
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    function() {
                        $('#deleteEventModal').modal('hide');
                        calendar.refetchEvents();
                    }
                );
            });

            $('#nominateForm').on('submit', function(e) {
                e.preventDefault();
                var selectedMembers = [];
                $('#membersContainer input:checked').each(function() {
                    selectedMembers.push($(this).val());
                });

                if (selectedMembers.length === 0) {
                    alert('Please select at least one member.');
                    return;
                }

                var eventId = $('#nominateForm').data('event-id');
                console.log('Event ID:', eventId); // Debugging line

                $.ajax({
    url: '/calendar/nominate-member/' + eventId + '/',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({
        members: selectedMembers
    }),
    headers: {
        'X-CSRFToken': '{{ csrf_token }}'
    },
    success: function(response) {
        if (response.status === 'success') {
            $('#nominateMemberModal').modal('hide');
            alert('Members nominated successfully.');
        } else {
            alert('Error: ' + response.message);
        }
    },
    error: function(xhr, status, error) {
        console.error('AJAX Error:', status, error);
        alert('An error occurred.');
    }
});


            });
        });
    </script>
</body>
</html>
